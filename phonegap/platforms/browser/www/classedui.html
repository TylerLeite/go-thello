<!DOCTYPE html>
<html>
	<head>
		<title>スーパーキャプチャゲーム!</title>
		<!-- Sūpā Kyapucha Gēmu! -->
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
		<link rel="stylesheet" href="js/lib/jQueryMobile/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="css/index.css" id="styling">
		<script src="js/lib/jQuery/jquery-1.12.2.min.js"></script>
		<script src="js/lib/jQueryMobile/jquery.mobile-1.4.5.min.js"></script>
		<script src="js/board.js"></script>
		<script src="js/ai.js"></script>
		<script src="js/settings.js"></script>

		<script>
			$(document).bind("mobileinit",function() {
				$.mobile.changePage.defaults.changeHash = false;
				$.mobile.hashListeningEnabled = false;
				$.mobile.pushStateEnabled = false;
			});

			var settings = new GT.Settings();

			for (var i = 1; i < settings.numPlayers + 1; i++){
				var player = '.player' + i.toString();
				$(player).css('background-image', 'url("' + settings.getPiece(i-1) + '")');
				$(player).css('background-size', 'contain');
			}

			var cur_music = 'menu';
			var music = new Audio('aud/' + cur_music + '.ogg');
			music.addEventListener('ended', function() {
				this.currentTime = 0;
				this.play();
			}, false);

			music.play();

			// Audio
			switch_music = function(new_music) {
				cur_music = new_music;
				music.setAttribute('src', 'aud/' + cur_music + '.ogg');
				music.load();
				music.play();
			}
		</script>
	</head>
	<body>
		<div class="text-resize"><div class = "sizer">0</div></div>
		<div data-role="page" id="home" class = "menu">
			<div class="title"></div>
			<center>
				<a href="#level-select" class = "single">
					<div class="menu-float" style="background-image: url(img/icons/singleplayer.png);"></div>
				</a>
				<a href="#board" class = "multi">
					<div class="menu-float" style="background-image: url(img/icons/multiplayer.png);"></div>
				</a>
				<a href="#board" class = "online">
					<div class="menu-float" style="background-image: url(img/icons/online.png);"></div>
				</a>
				<a href="#settings" class = "settings">
					<div class="menu-float" style="background-image: url(img/icons/settings.png);"></div>
				</a>
			</center>
		</div>
		<div data-role="page" id="level-select" class = "menu">
			<center>
				<a href="#board" class = "level" id = "1">
					<div class="menu-float" style="background-image: url(img/icons/singleplayer.png);"></div>
				</a>
			</center>
			<a class="back-btn ui-btn ui-icon-back ui-btn-icon-left" onclick="history.go(-1);">BACK</a>
		</div>
		<div data-role="page" id="board">
			<center>
				<div class="top-score score-board">
				</div>
				<div class="game-board">

				</div>
				<div class="bottom-score score-board">
				</div>
			</center>
			<a class="back-btn ui-btn ui-icon-back ui-btn-icon-left" onclick="history.go(-1);">BACK</a>
			<a class="settings-btn ui-btn ui-icon-gear ui-btn-icon-left">SETTINGS</a>
			<div class="alert">
				<center>
					<div class="alert-message"></div>
					<div class="ok-btn">OK</div>
				</center>
			</div>
		</div>
	</body>
	<script>
		if (UI === null || typeof(UI) != "object"){ var UI = new Object();}
		/*
		* UI BOARD CONSTRUCTOR
		* 'turn' keeps track of the current turn starting with 1
		* 'maxTurn' holds the maximum number of players
		* 'single' keeps track of whether the game is single or multi player
		* 'sBoard' is the board object (should have board size in config eventually)
		* 'sArray' is the 2D array of tiles
		* 'randoBot' is the AI object
		*/
		UI.Board = function(board, maxTurn){
			this.turn = 1;
			this.maxTurn = maxTurn;
			this.single = false;
			this.sBoard = board;
			this.sArray = sBoard.tiles();
			this.Bot = new GT.AI(board);
			this.level = 0;
			this.squareSize = 0;

			/*
			* For the width of the board, add file columns
			*/
			var letter = 'a';
			for (var i = 0; i < this.sBoard.wdt(); i++){
				$('.game-board').append('<div class="board-file ' + letter + '"></div>');
				letter = nextChar(letter);
			}

			/*
			* In each file column, for the height of the board, add rank squares
			*/
			$('.board-file').each(function() {
				number = this.sBoard.hgt();
				for (var i = 0; i < this.sBoard.hgt(); i++){
					$(this).append('<div class="board-rank ' + number + '"></div>');
					number -= 1;
				}
			});

			/*
			*	Since jQuery can only change styles for existing DOM objects, this for
			* loop adds style tags to the html to style the divs from the start.  The
			* loop styes the logos for each player based on the settings class.
			*/
			for (var i = 1; i < this.maxTurn+1; i++){
				var player = ".player" + i.toString();
				var logo = ".logo" + i.toString();
				var url = "url('" + settings.getPiece(i-1) + "')";
				$("<style type='text/css'>"+player+"{ background-image: "+url+"; }</style>")
	    		.appendTo(document.documentElement);
				$("<style type='text/css'>"+player+" { background-size: contain; }</style>")
	    		.appendTo(document.documentElement);
				$("<style type='text/css'>"+logo+"{ background-image: "+url+"; }</style>")
	    		.appendTo(document.documentElement);
				$("<style type='text/css'>"+logo+" { background-size: contain; }</style>")
	    		.appendTo(document.documentElement);
			}
		}
		UI.Board.prototype.setSingle = function(gameType){
			this.single = gameType;
			return;
		}
		UI.Board.prototype.getSquareSize = function(){
			return this.squareSize;
		}
		UI.Board.prototype.getHgt = function(){
			return this.sBoard.hgt();
		}
		UI.Board.prototype.getWdt = function(){
			return this.sBoard.wdt();
		}
		UI.Board.prototype.resize = function(){
			/*
			* Calculate the maximum height and width of each square, then take the
			* smaller of the two and use that as the square size. Minus 20 takes into
			* account the padding used.
			*/
			var winHgt = $(window).height();
			var winWdt = $(window).width();
			var fileWdt = (1/this.getWdt()) * (winWdt - 20);
			var rankHgt = (1/this.getHgt()) * (winHgt - 20);
			this.squareSize = Math.floor(Math.min(fileWdt,rankHgt));

			/*
			* Change the height and width of the columns and rows to fit the screen
			* minus 20 takes into account 10 px of padding on top and bottom
			*/
			$('.board-file').css('width',this.squareSize.toString());
			$('.board-file').css('height',(winHgt-20).toString());
			$('.board-rank').css('height',this.squareSize.toString());
		}
		/*
		* UI ALERT CONSTRUCTOR
		* We need to hide the custom alert to start
		*/
		UI.Alert = function(){
			this.output = "";
			$('.alert').hide();
		}
		/*
		* UI SCOREBOARD CONSTRUCTOR
		*/
		UI.ScoreBoard = function(){
		}
		/*
		*	This function resizes the text of the scores to be the right height and
		* width, this is separated from the resize function because it needs to be
		* called after the DOM objects are initialized since it relies on the
		* height and width of the .score container.
		*/
		UI.ScoreBoard.prototype.resizeText = function(){
			var digitHgt = $('.text-resize').height();
			var digitWdt = Math.floor($('.text-resize').width()/2);
			$('.sizer').css("fontSize","1px");
			fontSize = 1
			while($('.sizer').height() < digitHgt && $('.sizer').width()<digitWdt){
				fontSize += 1
				$('.sizer').css("font-size", fontSize+"px");
				$('.ones').css("font-size", fontSize+"px");
				$('.tens').css("font-size", fontSize+"px");
			}
		}
		/*
		* This function increases the score of a scoreboard given the
		* scoreboard class, the old score and the new score
		* setTimeout is to make it look all cool and count uppy... the score
		* board has a separate tens and ones place cause I'm an asshole and it
		* looks nicer when counting up to have it this way.  You can fix it if
		* you want to make it simple again.
		*/
		UI.ScoreBoard.prototype.increaseScore = function(label, oldS, newS){
			if (oldS < newS){
				if($(label).children('.ones').text() === "9"){
					var oldT = parseInt($(label).children('.tens').text());
					oldT += 1;
					$(label).children('.tens').text(oldT.toString());
					$(label).children('.ones').text("0");
				} else {
					var oldO = parseInt($(label).children('.ones').text());
					oldO += 1;
					$(label).children('.ones').text(oldO.toString());
				}
				oldS += 1;
				setTimeout(function(){increaseScore(label,oldS,newS)}, 100);
			}
		}
		/*
		* Opposite of the increase score function
		*/
		UI.ScoreBoard.prototype.decreaseScore = function(label, oldS, newS){
			if (oldS > newS){
				if($(label).children('.ones').text() === "0"){
					var oldT = parseInt($(label).children('.tens').text());
					oldT -= 1;
					$(label).children('.tens').text(oldT.toString());
					$(label).children('.ones').text("9");
				} else {
					var oldO = parseInt($(label).children('.ones').text());
					oldO -= 1;
					$(label).children('.ones').text(oldO.toString());
				}
				oldS -= 1;
				setTimeout(function(){decreaseScore(label,oldS,newS)}, 100);
			}
		}
		/*
		* Resets scroe ot zero
		*/
		UI.ScoreBoard.prototype.reset = function(){
			$('.score').children('.ones').text("0");
			$('.score').children('.tens').text("0");
		}
		UI.ScoreBoard.prototype.update = function(){
			/*
			* This function updates the scores by checking the dominance function
			* of the baord object nad calling increase/decrease score
			*/
				var dom = sBoard.dominance();
				var score1 = parseInt($('.score1').children('.tens').text())*10;
				score1 += parseInt($('.score1').children('.ones').text());
				var score2 = parseInt($('.score2').children('.tens').text())*10;
				score2 += parseInt($('.score2').children('.ones').text());
				if(score1 > dom[1]){
					decreaseScore('.score1',score1,dom[1]);
				} else if (score1 < dom[1]){
					increaseScore('.score1',score1,dom[1]);
				}
				if(score2 > dom[2]){
					decreaseScore('.score2',score2,dom[2]);
				} else if (score2 < dom[2]){
					increaseScore('.score2',score2,dom[2]);
				}
			}
		}
		UI.ScoreBoard.prototype.resize = function(board){
			/*
			* remHgt is the remaining board height left after the board is sized
			* remWdt is the remaining width
			* logo1/2 and score1/2 are divs to hold the logos and scores
			*/
			var winHgt = $(window).height();
			var winWdt = $(window).width();
			var remHgt = winHgt-(board.getSquareSize()*board.getHgt());
			var remWdt = winWdt-(board.getSquareSize()*board.getWdt());
			var logo1 = '<div class = "logo logo1"></div>';
			var score1 = '<div class = "score score1"><div class = "tens">0</div><div class = "ones">0</div></div>'
			var logo2 = '<div class = "logo logo2"></div>';
			var score2 = '<div class = "score score2"><div class = "tens">0</div><div class = "ones">0</div></div>'

			/*
			* If the remaining height is greater, show only the top scoreboard
			* Size the scoreboard to the correct height (at least 50px + 20padding)
			* Make the scoreboard full width and top 0
			* Pad the game-board accordingly
			* Append the logo and score divs
			* Resize the logo and score divs
			* If scoreboard is less than 50px hide it
			*/
			var logoSize;
			if (remHgt > remWdt){
				if (remHgt >= 140){
					$('.score-board').css('height', ((remHgt/2)-20).toString());
					$('.score-board').append(logo1+score1+logo2+score2);

					var extraPad = (remHgt/2)-20;
					extraPad += ((remHgt - extraPad - 50) / 4);
					$('.game-board').css('padding-top', extraPad.toString()+"px");

					var logoWdt = (1/4) * (winWdt);
					var logoHgt = (remHgt/2)-20;
					logoSize = Math.floor(Math.min(logoWdt,logoHgt));
					$('.logo').css("width", logoSize.toString());
					$('.logo').css("height", logoSize.toString());
					$('.score').css("width", logoSize.toString());
					$('.score').css("height", logoSize.toString());
					var extraLogo = winWdt - (logoSize * 4);
					$('.logo2').css("margin-left",extraLogo.toString()+"px");

					$('.top-score').css({left:'0',top:'0'}
					$('.top-score').css("height", logoSize.toString());
					$('.top-score').css("width","100%");
					$('.bottom-score').hide();
				} else {
					$('.top-score').hide();
					$('.bottom-score').hide();
				}
			} else {
				/*
				* Otherwise add the logos to the top and bottom scores and
				* make sure the game-board is centered
				*/
				$('.top-score').append(logo1+score1);
				$('.top-score').css({top:"10px",left:"10px"});

				$('.bottom-score').show();
				$('.bottom-score').append(logo2+score2);

				$('.game-board').css('padding-top', "10px")
				var logoWdt = (remWdt/2)-20;
				var logoHgt = (winHgt*.6);
				logoSize = Math.floor(Math.min(logoWdt/2,logoHgt));
				$('.score-board').css('width', (logoSize*2).toString());
				$('.score-board').css('height', logoSize.toString());
				if (remWdt/2 >= 400){
					$('.top-score').css('left', (((remWdt/2)-400)/2).toString()+"px");
					$('.bottom-score').css('right', (((remWdt/2)-400)/2).toString()+"px");
				}
			}
			logoSize = Math.min(logoSize,200).toString()+"px";
			$('.text-resize').css({height:logoSize,width:logoSize});
		}

		UI.Menu = function(){
		}

		UI.Menu.prototype.resize = function(){
			var winHgt = $(window).height();
			var winWdt = $(window).width();
			var floatSize = Math.floor(Math.min(winHgt, winWdt) * .40);
			floatSize = floatSize.toString() + "px";
			$('.menu-float').css({height:floatSize, width:floatSize});
		}

		var gamestate = new GT.Board(7,7);
		var board = new UI.Board(gamestate);
		/*
		* JqueryMobile has a loader symbol that needs to be hidden after page load
		*/
		window.onload = function () {
			$(".ui-loader").hide();
		}

		/*
		*	When single, multi or online is clicked, single is toggled to true or false
		*/
		$('.single').click(function(){switch_music('level-select'); board.setSingle(true);});
		$('.multi').click(function(){switch_music('game'); board.setSingle(false);});
		$('.level').click(function(){switch_music('game'); level = $(this).attr('id')});
		$('.online').click(function(){board.setSingle(false);});
		/*
		* When the back button is pressed, reset everything
		*/
		$('.back-btn').click(function(){
			sBoard.reset();
			updateBoard();
			resetScore();
			turn = 1;
			if (level != 0){
				switch_music('level-select')
				level = 0;
			} else {
				switch_music('menu');
			}
		});

		/*
		*	When the ok button on the alert is pressed, reset everything and have the
		* AI make it's move if it is the first turn in single player mode.
		*/
		$('.ok-btn').click(function(){
			sBoard.reset();
			updateBoard();
			resetScore();
			if (single === true && turn === 2){
				aiMove();
			}
			$('.alert').hide();
		});

		/*
		* This function returns the next character in the alphabet
		*/
		function nextChar(c) {
			return String.fromCharCode(c.charCodeAt(0) + 1);
		}



		/*
		*	The resize function resizes the board DOM objects to the right size.
		*/
		function resize(){
			resizeMenu();



			resizeText();
		}
		/*
		* on window orientation change resize everything ... this probably
		* doesn't work correctly
		*/
		$(window).on("orientationchange",function(){
			setTimeout(function(){
				$('#board').children().hide().show(0);
				$('.score-board').empty();
				resize();
				updateScore();
				$('.alert').hide();
			},100);
		});



		/*
		* Updates the UI to display the current layout
		*/
		function updateBoard() {
			for (var y = 0; y < sBoard.hgt(); y++){
				for (var x = 0; x < sBoard.wdt(); x++){
					var file = '.' + String.fromCharCode(97+x);
					var rank = '.' + (y+1).toString();

					if (sArray[y][x] != (maxTurn + 1)){
						var pnum = '1';
						if (sArray[y][x] == 2 || sArray[y][x] == 5){
							pnum = '2';
						}

						/*
						* this part adds player logos to the discs
						* it is a bit more complex in order to accomidate more than
						* two players since there are only two sides to a disc
						*/
						var player = 'player'+pnum;
						var front = $(file).children(rank).find('.front');
						var back = $(file).children(rank).find('.back');
						var disc = $(file).children(rank).children('.disc');
						if (disc.attr('class').indexOf('flipped') <= -1){
							if (front.attr('class').indexOf(player) <= -1){
								player = player + ' back';
								back.attr('class', player);
								disc.toggleClass('flipped');
							}
						} else {
							if (back.attr('class').indexOf(player) <= -1){
								player = player + ' front';
								front.attr('class', player);
								disc.toggleClass('flipped');
							}
						}
					} else {
						$(file).children(rank).children().remove();
						$(file).children(rank).css('opacity',0.6.toString());
					}
				}
			}
		}

		/*
		* makes randobot moves
		*/
		var aiMove = function() {
			var mv = randoBot.makeMove();
			var file = '.' + String.fromCharCode(97+mv[0]);
			var rank = '.' + (mv[1]+1).toString();
			$(file).children(rank).click();
		};

		/*
		* Handles when a tile is clicked, first checks if valid, then changes the
		* tile and updates the board, then checks if all tiles have been filled
		* and if so declares a winner.
		*/
		function addTile() {
			var file = $(this).parent().attr('class').slice(-1).charCodeAt(0) - 97;
			var rank = parseInt($(this).attr('class').slice(-1)) - 1;

			if (sBoard.place(file, rank, turn)){
				var front = '<div class="player'+turn.toString()+' front"></div>';
				var back = '<div class="player'+turn.toString()+' back"></div>';
				$(this).append('<div class="disc">'+front+back+'</div>');
				$(this).css("opacity",(1.0).toString());
				if (turn === maxTurn){
					turn = 1;
				} else {
					turn += 1;
					if (single === true && sBoard.emp() > 0){
						$('.board-rank').off('click',addTile);
						setTimeout(function(){
							$('.board-rank').on('click',addTile);
  						aiMove();
						}, 1000);
					}
				}

				updateBoard();
				updateScore();

				if (sBoard.emp() === 0){
					var dom = sBoard.dominance();
					var winner = dom[0];
					var p1 = dom[1].toString();
					var p2 = dom[2].toString();

					if (p2 > p1){
						var temp = p2;
						p2 = p1;
						p1 = temp;
					}

					if (winner <= maxTurn){
						$('.alert-message').text(settings.getName(winner-1) + " wins! (" + p1 + " to " + p2 +")");
					} else {
						$('.alert-message').text('It\'s a tie!');
					}
					$('.alert').show();
				}
			}
		}

		/*
		* resize the board, and the text on initialization
		*/
		resize();
		$('.board-rank').on('click',addTile);
	</script>
</html>
