<!DOCTYPE HTML>
<html>
	<head>
		<title>GOthello</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="css/index.css">
		<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script src="js/board.js"></script>
		<script src="js/ai.js"></script>
		<script src="js/settings.js"></script>
		
		<script>
			$(document).bind("mobileinit",function() {
				$.mobile.changePage.defaults.changeHash = false;
				$.mobile.hashListeningEnabled = false;
				$.mobile.pushStateEnabled = false;
			});

			var settings = new GT.Settings();

			for (var i = 1; i < settings.numPlayers + 1; i++){
				var player = '.player' + i.toString();
				$(player).css('background-image', 'url("' + settings.getPiece(i-1) + '")');
				$(player).css('background-size', 'contain');
			}
		</script>

		<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	</head>
	<body>
		<div data-role="page" id="home">
			<div data-role="header">
				<h3>GOthello!</h3>
			</div>
			<div data-role="content">
				<div class="scroll_wrapper ui-content" data-isscroll>
					<ul data-role="listview" id="home_menu" data-theme="a">
						<li><a class="single" href="#board" data-transition="flip">Single Player</a></li>
						<li><a class="double" href="#board" data-transition="flip">Multiplayer</a></li>
					</ul>
				</div>
			</div>
		</div>
		<div data-role="page" id="board">
			<center>
				<div class="game-board">

				</div>
			</center>
			<a class="back-btn ui-btn ui-icon-back ui-btn-icon-left" href="#home">BACK</a>
			<a class="settings-btn ui-btn ui-icon-gear ui-btn-icon-left">SETTINGS</a>
			<div class="alert">
				<center>
					<div class="alert-message"></div>
					<div class="ok-btn">OK</div>
				</center>
			</div>
		</div>
	</body>
	<script>
		/*
		* This function returns the next character in the alphabet
		*/
		function nextChar(c) {
			return String.fromCharCode(c.charCodeAt(0) + 1);
		}

		var turn = 1;
		var maxTurn = 2;
		var single = false;

		$('.alert').hide();

		var settings = new GT.Settings()
		for (var i = 1; i < maxTurn+1; i++){
			player = ".player" + i.toString();
			var url = "url('" + settings.getPiece(i-1) + "')";
			$("<style type='text/css'>"+player+"{ background-image: "+url+"; }</style>")
    		.appendTo(document.documentElement);
			$("<style type='text/css'>"+player+" { background-size: contain; }</style>")
    		.appendTo(document.documentElement);
			console.log($(player).css("background-image"))
		}

		$('.single').click(function(){single = true;});
		$('.double').click(function(){single = false;});
		$('.back').click(function(){sBoard.reset(); updateBoard(); turn = 1;})
		$('.ok-btn').click(function(){
			sBoard.reset();
			updateBoard();
			if (single === true && turn === 2){
				aiMove();
			}
			$('.alert').hide();
		});

		/*
		* Initialize the board (should eventually look for a configuration file
		* instead of just hard coding the size)
		*/
		var sBoard = new GT.Board(7,7);
		var sArray = sBoard.tiles();

		/**
		 * randoBot takes no prisoners
		 */
		var randoBot = new GT.AI(sBoard);

		/*
		* Calculate the maximum height and width of each square, then take the
		* smaller of the two and use that as the square size. Minus 20 takes into
		* account the padding used.
		*/
		var fileWdt = (1/sBoard.wdt()) * ($(window).width() - 20);
		var rankHgt = (1/sBoard.hgt()) * ($(window).height() - 20);

		if (fileWdt <= rankHgt){
			rankHgt = fileWdt;
		} else{
			fileWdt = rankHgt;
		}

		/*
		* For the width of the board, add file columns
		*/
		var letter = 'a';
		for (var i = 0; i < sBoard.wdt(); i++){
			$('.game-board').append('<div class="board-file ' + letter + '"></div>');
			letter = nextChar(letter);
		}

		/*
		* In each file column, for the height of the board, add rank squares
		*/
		$('.board-file').each(function() {
			number = sBoard.hgt();
			for (var i = 0; i < sBoard.hgt(); i++){
				$(this).append('<div class="board-rank ' + number + '"></div>');
				number -= 1;
			}
		});

		/*
		* Change the height and width of the columns and rows to fit the screen
		* minus 20 takes into account 10 px of padding on top and bottom
		*/
		$('.board-file').css('width',Math.floor(fileWdt).toString());
		$('.board-file').css('height',($(window).height()-20).toString());
		$('.board-rank').css('height',Math.floor(rankHgt).toString());

		/*
		* Updates the UI to display the current layout
		*/
		function updateBoard() {
			for (var y = 0; y < sBoard.hgt(); y++){
				for (var x = 0; x < sBoard.wdt(); x++){
					var file = '.' + String.fromCharCode(97+x);
					var rank = '.' + (y+1).toString();

					if (sArray[y][x] != (maxTurn + 1)){
						var player = 'player'+sArray[y][x].toString();
						var front = $(file).children(rank).find('.front');
						var back = $(file).children(rank).find('.back');
						var disc = $(file).children(rank).children('.disc');
						if (disc.attr('class').indexOf('flipped') <= -1){
							if (front.attr('class').indexOf(player) <= -1){
								player = player + ' back';
								back.attr('class', player);
								disc.toggleClass('flipped');
							}
						} else {
							if (back.attr('class').indexOf(player) <= -1){
								player = player + ' front';
								front.attr('class', player);
								disc.toggleClass('flipped');
							}
						}
					}	else {
								$(file).children(rank).children().remove();
								$(file).children(rank).css('opacity',0.6.toString());
					}
				}
			}
		}
		var aiMove = function() {
			var mv = randoBot.makeMove();
			var file = '.' + String.fromCharCode(97+mv[0]);
			var rank = '.' + (mv[1]+1).toString();
			$(file).children(rank).click();
		};

		/*
		* Handles when a tile is clicked, first checks if valid, then changes the
		* tile and updates the board, then checks if all tiles have been filled
		* and if so declares a winner.
		*/
		function addTile() {
			var file = $(this).parent().attr('class').slice(-1).charCodeAt(0) - 97;
			var rank = parseInt($(this).attr('class').slice(-1)) - 1;

			if (sBoard.place(file, rank, turn)){
				var front = '<div class="player'+turn.toString()+' front"></div>';
				var back = '<div class="player'+turn.toString()+' back"></div>';
				$(this).append('<div class="disc">'+front+back+'</div>');
				$(this).css("opacity",(1.0).toString());
				if (turn === maxTurn){
					turn = 1;
				} else {
					turn += 1;
					if (single === true && sBoard.emp() > 0){
						$('.board-rank').off('click',addTile);
						setTimeout(function(){
							$('.board-rank').on('click',addTile);
  						aiMove();
						}, 1000);
					}
				}

				updateBoard();

				if (sBoard.emp() === 0){
					var dom = sBoard.dominance();
					var winner = dom[0];
					var p1 = dom[1].toString();
					var p2 = dom[2].toString();

					if (p2 > p1){
						var temp = p2;
						p2 = p1;
						p1 = temp;
					}

					if (winner <= maxTurn){
						$('.alert-message').text("Player " + settings.getName(winner-1) + " wins! (" + p1 + " to " + p2 +")");
					} else {
						$('.alert-message').text('It\'s a tie!');
					}
					$('.alert').show();
				}
			}
		}
		$('.board-rank').on('click',addTile);
	</script>
</html>
