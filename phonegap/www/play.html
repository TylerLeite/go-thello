<!DOCTYPE HTML>
<html>
  <head>
      <title>GOthello</title>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
      <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
      <link rel="stylesheet" href="css/play.css">
      <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
      <script src="js/board.js"></script>
      <script>
      $(document).bind("mobileinit",function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
      });
      </script>
      <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
  </head>
  <body>
    <div data-role="page" id="home">
      <div data-role="header">
        <h3>GOthello!</h3>
      </div>
      <div data-role="content">
        <div class="scroll_wrapper ui-content" data-isscroll>
          <ul data-role="listview" id="home_menu" data-theme="a">
            <li><a class="single" href="#board" data-transition="flip">Single Player</a></li>
            <li><a class="double" href="#board" data-transition="flip">Multiplayer</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div data-role="page" id="board">
      <center>
        <div class="game-board">

        </div>
      </center>
      <a class="back ui-btn ui-icon-back ui-btn-icon-left" href="#home">BACK</a>
      <a class="settings ui-btn ui-icon-gear ui-btn-icon-left">SETTINGS</a>
    </div>
  </body>
  <script>
    /*
    * This function returns the next character in the alphabet
    */
    function nextChar(c) {
      return String.fromCharCode(c.charCodeAt(0) + 1);
    }

    turn = 1;
    max_turn = 2;

    $(".single").click(function(){
    });

    /*
    * Initialize the board (should eventually look for a configuration file
    * instead of just hard coding the size)
    */
    var s_board = new GT.Board(7,7);
    var s_array = s_board.tiles();

    /*
    * Calculate the maximum height and width of each square, then take the
    * smaller of the two and use that as the square size. Minus 20 takes into
    * account the padding used.
    */
    var file_wdt = (1/s_board.wdt())*($(window).width()-20);
    var rank_hgt = (1/s_board.hgt())*($(window).height()-20);
    if (file_wdt <= rank_hgt){
      rank_hgt = file_wdt;
    }
    else{
      file_wdt = rank_hgt;
    }

    /*
    * For the width of the board, add file columns
    */
    var letter = 'a';
    for (var i = 0; i < s_board.wdt(); i++){
      $('.game-board').append('<div class="board-file '+letter+'"></div>');
      letter = nextChar(letter);
    }

    /*
    * In each file column, for the height of the board, add rank squares
    */
    $('.board-file').each(function(){
      number = s_board.hgt();
      for (var i = 0; i < s_board.hgt(); i++){
        $(this).append('<div class="board-rank '+number+'"></div>');
        number-=1;
      }
    });

    /*
    * Change the height and width of the columns and rows to fit the screen
    * minus 20 takes into account 10 px of padding on top and bottom
    */
    $('.board-file').css("width",Math.floor(file_wdt).toString());
    $('.board-file').css("height",($(window).height()-20).toString());
    $('.board-rank').css("height",Math.floor(rank_hgt).toString());

    /*
    * Updates the UI to display the current layout
    */
    function updateBoard() {
      for(var y = 0; y < s_board.hgt(); y++){
        for (var x = 0; x < s_board.wdt(); x++){

          var file = '.'+String.fromCharCode(97+x)
          var rank = '.'+(y+1).toString()

          if (s_array[y][x] != (max_turn + 1)){
            var player = "player"+s_array[y][x].toString()
            $(file).children(rank).children().attr("class", player)
          }

          else{
            $(file).children(rank).children().remove();
            $(file).children(rank).css("opacity",0.6.toString())
          }
        }
      }
    }

    /*
    * Handles when a tile is clicked, first checks if valid, then changes the
    * tile and updates the board, then checks if all tiles have been filled
    * and if so declares a winner.
    */
    $(".board-rank").click(function(){
        var file = $(this).parent().attr('class').slice(-1).charCodeAt(0)-97
        var rank = parseInt($(this).attr('class').slice(-1))-1

        if (s_board.place(file,rank,turn)){
          $(this).append('<div class="player'+turn.toString()+'"></div>')
          $(this).css("opacity",(1.0).toString());
          if (turn === max_turn){
            turn = 1
          }
          else {
            turn += 1
          }
          updateBoard();

          if (s_board.emp() === 0){
            var winner = s_board.dominance();

            if (winner<=max_turn){
              alert("Player "+winner+" wins!");
            }

            else{
              alert("It's a tie!");
            }
            s_board.reset();
            updateBoard();
          }
        }
    });
  </script>
</html>
